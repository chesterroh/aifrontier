---
interface Props {
  lang?: 'ko' | 'en';
}

const { lang = 'ko' } = Astro.props;
const placeholder = lang === 'ko' ? '검색...' : 'Search...';
---

<div class="search-container relative">
  <button
    id="search-btn"
    type="button"
    class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
    aria-label={placeholder}
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      />
    </svg>
  </button>

  <div
    id="search-modal"
    class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm"
  >
    <div class="flex items-start justify-center pt-20 px-4">
      <div class="w-full max-w-2xl bg-white dark:bg-gray-900 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div id="pagefind-container" class="p-4"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const searchBtn = document.getElementById('search-btn');
  const searchModal = document.getElementById('search-modal');
  let pagefindLoaded = false;

  async function loadPagefind() {
    if (pagefindLoaded) return;

    try {
      // Use string concatenation to prevent Vite from analyzing the import
      const pagefindPath = '/pagefind/' + 'pagefind.js';
      // @ts-ignore
      const pagefind = await import(/* @vite-ignore */ pagefindPath);
      await pagefind.init();

      const container = document.getElementById('pagefind-container');
      if (container) {
        // @ts-ignore
        new pagefind.PagefindUI({
          element: container,
          showSubResults: true,
          showImages: false,
        });
      }
      pagefindLoaded = true;
    } catch (e) {
      console.error('Pagefind not available:', e);
      const container = document.getElementById('pagefind-container');
      if (container) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">검색 기능은 빌드 후 사용 가능합니다.</p>';
      }
    }
  }

  function openSearch() {
    searchModal?.classList.remove('hidden');
    loadPagefind();
    document.body.style.overflow = 'hidden';
    setTimeout(() => {
      const input = document.querySelector('#pagefind-container input') as HTMLInputElement;
      input?.focus();
    }, 100);
  }

  function closeSearch() {
    searchModal?.classList.add('hidden');
    document.body.style.overflow = '';
  }

  searchBtn?.addEventListener('click', openSearch);

  searchModal?.addEventListener('click', (e) => {
    if (e.target === searchModal) {
      closeSearch();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeSearch();
    }
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openSearch();
    }
  });
</script>

<style is:global>
  /* Pagefind UI Styles */
  .pagefind-ui {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: #0ea5e9;
    --pagefind-ui-text: #1f2937;
    --pagefind-ui-background: #ffffff;
    --pagefind-ui-border: #e5e7eb;
    --pagefind-ui-tag: #f3f4f6;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 8px;
    --pagefind-ui-font: 'Pretendard Variable', 'Inter', sans-serif;
  }

  @media (prefers-color-scheme: dark) {
    .pagefind-ui {
      --pagefind-ui-text: #f3f4f6;
      --pagefind-ui-background: #111827;
      --pagefind-ui-border: #374151;
      --pagefind-ui-tag: #1f2937;
    }
  }

  .pagefind-ui__search-input {
    width: 100%;
    padding: 12px 16px;
    font-size: 16px;
    border-radius: var(--pagefind-ui-border-radius);
  }

  .pagefind-ui__result-link {
    color: var(--pagefind-ui-primary);
  }
</style>
