---
interface Props {
  videoId: string;
  title?: string;
}

const { videoId, title = 'YouTube video' } = Astro.props;
---

<div class="youtube-wrapper">
  <!-- Placeholder to maintain layout when mini player is active -->
  <div id="youtube-placeholder" class="hidden aspect-video bg-gray-200 dark:bg-gray-800 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
    <div class="text-gray-500 dark:text-gray-400 flex flex-col items-center gap-2">
      <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24">
        <path d="M8 5v14l11-7z"/>
      </svg>
      <span class="text-sm">클릭하여 영상으로 돌아가기</span>
    </div>
  </div>

  <!-- Main player container -->
  <div id="youtube-container" class="youtube-container relative w-full aspect-video bg-gray-900 rounded-lg overflow-hidden">
    <div id="youtube-player" data-video-id={videoId}></div>

    <!-- Mini player controls (shown only in mini mode) -->
    <div id="mini-controls" class="hidden absolute top-2 right-2 z-10 flex gap-2">
      <button id="mini-expand" class="bg-black/70 hover:bg-black/90 text-white rounded-full p-2.5 transition-colors" title="크게 보기">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
        </svg>
      </button>
      <button id="mini-close" class="bg-black/70 hover:bg-black/90 text-white rounded-full p-2.5 transition-colors" title="닫기">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Modal backdrop for expanded view (player stays in place, CSS positions it) -->
  <div id="player-modal" class="hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm"></div>
</div>

<script>
  declare global {
    interface Window {
      onYouTubeIframeAPIReady: () => void;
      YT: any;
      ytPlayer: any;
      seekToTime: (seconds: number) => void;
    }
  }

  const container = document.getElementById('youtube-container');
  const placeholder = document.getElementById('youtube-placeholder');
  const miniControls = document.getElementById('mini-controls');
  const miniClose = document.getElementById('mini-close');
  const miniExpand = document.getElementById('mini-expand');
  const sidebarSlot = document.getElementById('sidebar-player-slot');
  const playerModal = document.getElementById('player-modal');

  let isMiniMode = false;
  let isModalMode = false;
  let isTheaterMode = false;
  let isFullscreenMode = false;
  let userClosedMini = false;
  const hasSidebar = () => window.innerWidth >= 1024;
  const isTablet = () => window.innerWidth >= 768 && window.innerWidth < 1024;
  const isMobile = () => window.innerWidth < 1024;

  function initPlayer() {
    const playerEl = document.getElementById('youtube-player');
    if (!playerEl) return;

    const videoId = playerEl.dataset.videoId;
    if (!videoId) return;

    window.ytPlayer = new window.YT.Player('youtube-player', {
      videoId: videoId,
      width: '100%',
      height: '100%',
      playerVars: {
        rel: 0,
        modestbranding: 1,
      },
    });
  }

  // Load YouTube IFrame API
  if (!document.getElementById('youtube-api')) {
    const tag = document.createElement('script');
    tag.id = 'youtube-api';
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode?.insertBefore(tag, firstScriptTag);
  }

  // Initialize when API is ready
  if (window.YT && window.YT.Player) {
    initPlayer();
  } else {
    window.onYouTubeIframeAPIReady = initPlayer;
  }

  // Position player at sidebar slot location using CSS (no DOM move)
  function positionAtSidebar() {
    if (!container || !sidebarSlot) return;

    const rect = sidebarSlot.getBoundingClientRect();
    container.style.position = 'fixed';
    container.style.top = `${rect.top}px`;
    container.style.left = `${rect.left}px`;
    container.style.width = `${rect.width}px`;
    container.style.height = 'auto';
    container.style.aspectRatio = '16 / 9';
    container.style.zIndex = '50';
    container.style.borderRadius = '0.5rem';
    container.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
  }

  function clearPositionStyles() {
    if (!container) return;
    container.style.position = '';
    container.style.top = '';
    container.style.left = '';
    container.style.width = '';
    container.style.height = '';
    container.style.aspectRatio = '';
    container.style.zIndex = '';
    container.style.borderRadius = '';
    container.style.boxShadow = '';
    container.style.bottom = '';
    container.style.right = '';
    container.style.transform = '';
    container.style.maxWidth = '';
  }

  // Mini player functions - use CSS only, no DOM moves to preserve playback
  function enableMiniMode() {
    if (isMiniMode || userClosedMini || !container || !placeholder) return;

    isMiniMode = true;
    placeholder.classList.remove('hidden');
    miniControls?.classList.remove('hidden');

    if (hasSidebar() && sidebarSlot) {
      // Desktop with sidebar: position at sidebar slot location
      sidebarSlot.classList.remove('hidden');
      positionAtSidebar();
    } else if (isTablet()) {
      // Tablet (768-1024px): floating top-right
      container.classList.add('mini-player-top-right');
    } else {
      // Mobile: floating bottom-right
      container.classList.add('mini-player-floating');
    }
  }

  function disableMiniMode() {
    if (!isMiniMode || !container || !placeholder) return;

    isMiniMode = false;
    userClosedMini = false;

    // Clear all position styles
    clearPositionStyles();
    container.classList.remove('mini-player-floating');
    container.classList.remove('mini-player-top-right');
    placeholder.classList.add('hidden');
    miniControls?.classList.add('hidden');
    sidebarSlot?.classList.add('hidden');
  }

  function closeMiniPlayer() {
    userClosedMini = true;
    disableMiniMode();
  }

  function openModal() {
    if (!container || !playerModal) return;

    // Mobile: theater mode → fullscreen landscape → (cycle)
    if (isMobile()) {
      if (isFullscreenMode) return;
      if (isTheaterMode) {
        // Second click: go to fullscreen landscape
        enableFullscreenLandscape();
        return;
      }
      // First click: enter theater mode
      enableTheaterMode();
      return;
    }

    if (isModalMode) return;
    isModalMode = true;

    // Clear previous position styles and apply modal styles
    clearPositionStyles();
    container.classList.remove('mini-player-floating');
    container.classList.add('modal-player');

    // Show modal backdrop
    playerModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Hide mini controls in modal
    miniControls?.classList.add('hidden');
  }

  function enableTheaterMode() {
    if (!container || isTheaterMode) return;

    isTheaterMode = true;

    // Clear mini player styles
    clearPositionStyles();
    container.classList.remove('mini-player-floating');
    container.classList.remove('mini-player-top-right');

    // Apply theater mode
    container.classList.add('theater-mode');

    // Add padding to body to push content below theater player
    const playerHeight = window.innerWidth * (9 / 16); // 16:9 aspect ratio
    document.body.style.paddingTop = `${playerHeight}px`;

    // Hide placeholder since player is visible at top
    placeholder?.classList.add('hidden');

    // Update mini controls to show close button (to exit theater)
    miniControls?.classList.remove('hidden');
  }

  function disableTheaterMode() {
    if (!container || !isTheaterMode) return;

    isTheaterMode = false;

    // Remove theater styles
    container.classList.remove('theater-mode');
    document.body.style.paddingTop = '';

    // Restore mini mode if scrolled away
    if (isMiniMode) {
      placeholder?.classList.remove('hidden');
      if (isTablet()) {
        container.classList.add('mini-player-top-right');
      } else {
        container.classList.add('mini-player-floating');
      }
      miniControls?.classList.remove('hidden');
    } else {
      clearPositionStyles();
      miniControls?.classList.add('hidden');
    }
  }

  async function enableFullscreenLandscape() {
    if (!container || isFullscreenMode) return;

    try {
      // Request fullscreen on the container
      if (container.requestFullscreen) {
        await container.requestFullscreen();
      } else if ((container as any).webkitRequestFullscreen) {
        await (container as any).webkitRequestFullscreen();
      }

      // Try to lock orientation to landscape
      if (screen.orientation && screen.orientation.lock) {
        try {
          await screen.orientation.lock('landscape');
        } catch (e) {
          // Orientation lock may not be supported or allowed
          console.log('Orientation lock not supported');
        }
      }

      isFullscreenMode = true;

      // Apply fullscreen styles
      container.classList.remove('theater-mode');
      container.classList.add('fullscreen-landscape');
      document.body.style.paddingTop = '';

      // Hide mini controls in fullscreen (browser provides its own)
      miniControls?.classList.add('hidden');
    } catch (e) {
      console.log('Fullscreen not supported');
    }
  }

  function disableFullscreenLandscape() {
    if (!container || !isFullscreenMode) return;

    isFullscreenMode = false;

    // Exit fullscreen
    if (document.fullscreenElement) {
      document.exitFullscreen();
    } else if ((document as any).webkitFullscreenElement) {
      (document as any).webkitExitFullscreen();
    }

    // Unlock orientation
    if (screen.orientation && screen.orientation.unlock) {
      try {
        screen.orientation.unlock();
      } catch (e) {
        // May not be supported
      }
    }

    // Remove fullscreen styles
    container.classList.remove('fullscreen-landscape');

    // Return to theater mode
    isTheaterMode = true;
    container.classList.add('theater-mode');
    const playerHeight = window.innerWidth * (9 / 16);
    document.body.style.paddingTop = `${playerHeight}px`;
    miniControls?.classList.remove('hidden');
  }

  // Handle fullscreen exit (e.g., user presses back button or swipes)
  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement && isFullscreenMode) {
      isFullscreenMode = false;
      container?.classList.remove('fullscreen-landscape');

      // Return to theater mode
      if (container && isMobile()) {
        isTheaterMode = true;
        container.classList.add('theater-mode');
        const playerHeight = window.innerWidth * (9 / 16);
        document.body.style.paddingTop = `${playerHeight}px`;
        miniControls?.classList.remove('hidden');
      }
    }
  });

  function closeModal() {
    // Handle theater mode exit
    if (isTheaterMode) {
      disableTheaterMode();
      return;
    }

    if (!container || !playerModal || !isModalMode) return;

    isModalMode = false;

    // Hide modal backdrop
    playerModal.classList.add('hidden');
    document.body.style.overflow = '';

    // Remove modal styles
    container.classList.remove('modal-player');
    clearPositionStyles();

    // Restore mini mode if active
    if (isMiniMode) {
      if (hasSidebar() && sidebarSlot) {
        sidebarSlot.classList.remove('hidden');
        positionAtSidebar();
      } else if (isTablet()) {
        container.classList.add('mini-player-top-right');
      } else {
        container.classList.add('mini-player-floating');
      }
      miniControls?.classList.remove('hidden');
    }
  }

  function scrollToPlayer() {
    placeholder?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(disableMiniMode, 300);
  }

  // Intersection Observer to detect when player leaves viewport
  const wrapper = document.querySelector('.youtube-wrapper');
  if (wrapper) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (!entry.isIntersecting && !userClosedMini) {
            enableMiniMode();
          } else if (entry.isIntersecting) {
            disableMiniMode();
          }
        });
      },
      { threshold: 0.1 }
    );

    observer.observe(wrapper);
  }

  // Event listeners
  miniClose?.addEventListener('click', (e) => {
    e.stopPropagation();
    if (isFullscreenMode) {
      disableFullscreenLandscape();
    } else if (isTheaterMode) {
      disableTheaterMode();
    } else {
      closeMiniPlayer();
    }
  });
  miniExpand?.addEventListener('click', (e) => {
    e.stopPropagation();
    openModal();
  });
  placeholder?.addEventListener('click', scrollToPlayer);

  // Close modal when clicking outside
  playerModal?.addEventListener('click', (e) => {
    if (e.target === playerModal) {
      closeModal();
    }
  });

  // Close modal, fullscreen, or theater mode with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (isFullscreenMode) {
        disableFullscreenLandscape();
      } else if (isTheaterMode) {
        disableTheaterMode();
      } else if (isModalMode) {
        closeModal();
      }
    }
  });

  // Handle resize and scroll - update sidebar position
  function updateSidebarPosition() {
    if (isMiniMode && !isModalMode && hasSidebar() && sidebarSlot) {
      positionAtSidebar();
    }
  }

  window.addEventListener('resize', () => {
    // Update theater mode padding on resize
    if (isTheaterMode) {
      const playerHeight = window.innerWidth * (9 / 16);
      document.body.style.paddingTop = `${playerHeight}px`;

      // Exit theater mode if resized to desktop
      if (!isMobile()) {
        disableTheaterMode();
      }
      return;
    }

    if (isMiniMode && !isModalMode) {
      clearPositionStyles();
      container?.classList.remove('mini-player-floating');
      container?.classList.remove('mini-player-top-right');
      if (hasSidebar() && sidebarSlot) {
        sidebarSlot.classList.remove('hidden');
        positionAtSidebar();
      } else if (isTablet()) {
        container?.classList.add('mini-player-top-right');
        sidebarSlot?.classList.add('hidden');
      } else {
        container?.classList.add('mini-player-floating');
        sidebarSlot?.classList.add('hidden');
      }
    }
  });

  // Update position on scroll for sidebar mode
  window.addEventListener('scroll', updateSidebarPosition, { passive: true });

  // Global function to seek to timestamp
  function seekToTime(seconds: number) {
    if (window.ytPlayer && window.ytPlayer.seekTo) {
      window.ytPlayer.seekTo(seconds, true);
      window.ytPlayer.playVideo();

      // Enable mini mode if scrolling away from player
      if (!isMiniMode && placeholder && !isElementInViewport(placeholder)) {
        userClosedMini = false;
        enableMiniMode();
      }
    }
  }

  function isElementInViewport(el: HTMLElement) {
    const rect = el.getBoundingClientRect();
    return rect.top < window.innerHeight && rect.bottom > 0;
  }

  // Expose globally
  window.seekToTime = seekToTime;

  // Handle chapter link clicks - scroll to corresponding heading
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const link = target.closest('[data-timestamp]') as HTMLElement;
    if (link) {
      e.preventDefault();
      const timestamp = link.dataset.timestamp;
      if (timestamp) {
        const parts = timestamp.split(':').map(Number);
        let seconds = 0;
        if (parts.length === 3) {
          seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
        } else if (parts.length === 2) {
          seconds = parts[0] * 60 + parts[1];
        }

        // Find and scroll to corresponding heading in prose
        const headings = document.querySelectorAll('.prose h2');
        for (const h2 of headings) {
          const em = h2.querySelector('em');
          if (em && em.textContent?.trim() === timestamp) {
            h2.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
          }
        }

        seekToTime(seconds);
      }
    }
  });
</script>

<style>
  .youtube-container {
    container-type: inline-size;
    transition: all 0.3s ease;
  }

  .youtube-container :global(iframe) {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  /* Mini player floating (mobile - top right) */
  .youtube-container.mini-player-floating {
    position: fixed;
    top: 5rem;
    right: 1rem;
    width: 280px;
    height: 157px;
    z-index: 50;
    border-radius: 0.5rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    aspect-ratio: auto;
  }

  @media (max-width: 640px) {
    .youtube-container.mini-player-floating {
      width: 200px;
      height: 112px;
      top: 4rem;
      right: 0.5rem;
    }
  }

  /* Mini player floating (tablet 768-1024px - top right) */
  .youtube-container.mini-player-top-right {
    position: fixed;
    top: 5rem;
    right: 1rem;
    width: 320px;
    height: 180px;
    z-index: 50;
    border-radius: 0.5rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    aspect-ratio: auto;
  }

  /* Modal player (expanded view) - centered fixed */
  .youtube-container.modal-player {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90vw;
    max-width: 1200px;
    height: auto;
    aspect-ratio: 16 / 9;
    z-index: 70;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
  }

  /* Theater mode (mobile) - fixed at top, full width */
  .youtube-container.theater-mode {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: auto;
    aspect-ratio: 16 / 9;
    z-index: 50;
    border-radius: 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  /* Fullscreen landscape mode */
  .youtube-container.fullscreen-landscape {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    border-radius: 0;
    background: #000;
  }

  .youtube-container.fullscreen-landscape :global(iframe) {
    width: 100%;
    height: 100%;
  }
</style>
